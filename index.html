<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no" />
    <title>Dodecagram</title>

    <link rel="stylesheet" type="text/css" href="dodecagram.css" />
  </head>
  <body>

    <div style="text-align: center">
      <canvas id="points"></canvas>
      <canvas id="canvas"></canvas>
    </div>

    <script type="text/javascript" src="dodecagram.js"></script>
    <script type="text/javascript">
      let synth;
  
      // touch & drag doesn't scroll window
      document.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, false);

      const canvas = document.getElementById('canvas');
      const points = document.getElementById('points');
      const star = new Star(
        canvas,
        points,
        window
      );

      canvas.addEventListener('mousedown', (e) => {
        startSynth()
        star.click(e);
      });

      const strings = [
        [0,  'zxcvbnm,./~~'], // sixth string
        [5,  'asdfghjkl;\'~'], // fifth string, starts on 'a'!
        [10, 'qwertyuiop[]'],  // fourth string
        [15, '1234567890-=']  // third string
      ];

      function getNoteFromKey(key) {
        for (const [tuning, string] of strings) {
          const note = string.indexOf(key);
          if (note >= 0)
            return note + tuning;
        }
        return null
      }

      window.addEventListener('keydown', (e) => {
      if (e.key === '/' || e.key === '\'')
        e.preventDefault(); // "quick search" hot keys

        startSynth();

        const note = getNoteFromKey(e.key);console.log(e.key, note)
        if (note === null)
          return;

        if (note >= 0) {
          if (star.editMode)
            star.selectOption(parseInt(note / 12), (note + 9) % 12 * 30);
          else
            star.selectNote(note);
          return;
        }
        if (e.key === 'Enter')
          star.toggleEditMode();
      });

      function startSynth() {
        if (synth)
          return;

        synth = new Synth();
        synth.start();
        star.bind(synth);

        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted')
                window.addEventListener('deviceorientation', (e) => {star.orientation(e)});
            });
        } else {
          window.addEventListener('deviceorientation', (e) => {star.orientation(e)});
        }
      }
    </script>
  </body>
</html>